name: ECSS Backend Django -  As of Jun 19 2025, 2000 hrs
on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read  # Required for actions/checkout
      id-token: write  # Required for Azure OIDC login

    environment:
      name: 'Production'

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python version
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          cd djangoPython
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Django checks
        run: |
          cd djangoPython
          # Check for deployment issues
          python manage.py check --deploy
          # Validate settings
          python manage.py diffsettings
          echo "Django checks completed"

      - name: Run tests (optional)
        run: |
          cd djangoPython
          # Add your test commands here if you have tests
          # python manage.py test
          echo "Skipping tests for now"

      - name: Prepare Django application for deployment
        run: |
          cd djangoPython
          # Collect static files for production
          python manage.py collectstatic --noinput
          
          # Verify requirements
          echo "=== Requirements.txt contents ==="
          cat requirements.txt
          echo "=== Installed packages ==="
          pip list
          
          # Create deployment package
          ls -la
          echo "Django application prepared for deployment"

      - name: Login to Azure using OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_38E8FE3E777C49248149EC6F5DFB03B7 }}
          tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_8B779764C58E492CA30F9427C7F5E046 }}
          subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_B3AD277132D54AFE83E323AED9C1A781 }}

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: 'ecss-backend-django'
          slot-name: 'Production'
          package: './djangoPython'
          
      - name: Wait for deployment to stabilize
        run: |
          echo "Waiting for deployment to stabilize..."
          sleep 60

      - name: Verify deployment with retry and logging
        run: |
          echo "Verifying deployment..."
          max_attempts=5
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "Attempt $attempt of $max_attempts"
            
            # Test health endpoint
            health_response=$(curl -s -o /dev/null -w "%{http_code}" -m 30 https://ecss-backend-django.azurewebsites.net/health/ || echo "000")
            root_response=$(curl -s -o /dev/null -w "%{http_code}" -m 30 https://ecss-backend-django.azurewebsites.net/ || echo "000")
            echo "Health endpoint HTTP Response: $health_response"
            echo "Root endpoint HTTP Response: $root_response"
            
            if [ "$health_response" = "200" ] || [ "$root_response" = "200" ]; then
              echo "‚úÖ Deployment verification successful!"
              curl -s https://ecss-backend-django.azurewebsites.net/health/ || echo "Health check details not available"
              exit 0
            else
              echo "‚ùå Attempt $attempt failed - Health: $health_response, Root: $root_response"
              
              # Get Azure App Service logs
              echo "üîç Fetching Azure App Service logs..."
              az webapp log download --name ecss-backend-django --resource-group $(az webapp show --name ecss-backend-django --query resourceGroup -o tsv) --log-file deployment-logs.zip || true
              
              if [ $attempt -eq $max_attempts ]; then
                echo "üí• All attempts failed. Check Azure portal for detailed logs."
                exit 1
              fi
              
              echo "‚è≥ Waiting 30 seconds before retry..."
              sleep 30
            fi
            
            attempt=$((attempt + 1))
          done
          